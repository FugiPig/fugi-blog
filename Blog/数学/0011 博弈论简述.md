# 0011: 博弈论简述

本篇为数学系列的第 1 篇, 关于本系列详见[0000: 博客目录](https://www.luogu.com.cn/blog/fugi-tech/post-0000-bo-ke-mu-lu).

## 1. 博弈论定义

**博弈论**, 是经济学的一个分支, 主要研究具有竞争或对抗性质的对象在一定规则下产生的行为. 博弈论考虑游戏中的个体的预测行为和实际行为, 并研究它们的优化策略. 

简单来说, 博弈论主要研究的就是在一个游戏中, 进行游戏的多位玩家所产生的游戏策略, 以及先后手是否有必胜策略

## 2. 公平组合游戏

**公平组合游戏（Impartial Game）**, 是指满足以下限制的游戏:

1. 游戏有两个人参与, 两人轮流进行操作, 双方均知道游戏的完整信息.

2. 任意一个游戏者对于同一游戏局面所可以做出的决策集合相同, 与游戏者无关, 即所有操作都是共同的(如象棋就不满足此条件, 因为游戏者无法操作对方的棋子).

3. 游戏中的同一个局面不可能多次出现.
4. 游戏以玩家无法行动为结束, 无法行动者为输, 且游戏一定会在有限步后以非平局结束. 

### 2.1 博弈状态图

我们可以将游戏中的一个状态抽象为有向图中的一个节点, 每个操作抽象成从原状态连向新状态的一条有向边, 这样得到的一个图就称为**博弈状态图**.

我们定义**必胜状态**为先手必胜的状态, **必败状态**为先手必败的状态, 即将操作状态的人的必胜必败对应到状态上.

根据公平组合游戏的限制和上述定义, 我们可以推导出定理11.1.

#### 定理11.1: 公平组合游戏基本定理

1. 没有后继状态(即在博弈状态图上无出边)的状态为**必败状态**.
2. 后继状态中存在必败状态的状态为**必胜状态**.
3. 后继状态全部为必胜状态的状态为**必败状态**.

> **证明**
>
> 1. 没有后继状态即无法行动, 根据限制4可得此时先手必败.
> 2. 若后继中存在必败状态, 则先手必然可以操作到对方先手的必败状态, 从而对方必败.
> 3. 若后继中全是必胜状态, 则无论如何操作都会到达对方先手的必胜状态, 从而己方必败.

### 2.2 有向图游戏

**有向图游戏**, 是指在一个只有一个起点的有向无环图上, 在起点处有一颗棋子, 两个玩家轮流沿有向边移动这颗棋子, 直到无法移动, 无法移动的人为输. 这是一个经典的公平组合游戏, 事实上大部分公平组合游戏均可转化为有向图游戏.

显然, 这颗棋子就相当于当前状态, 这个有向无环图就相当于博弈状态图. 而根据定理11.1, 若博弈状态图为有向无环图, 我们可以通过拓扑排序在$\varTheta(N+M)$的时间($N$为状态数, $M$为操作数)内求出每个状态是必胜还是必败. 接下来的推导过程中, 无论是`点`还是`状态`, 指的都是博弈状态图上的点.

以上就是将公平组合游戏转化为有向图游戏的方法, 对于有向图游戏我们要求解的就是起点处的先后手胜负情况. 为了求解更高效地求解, 以及求解包含多个有向图的有向图游戏, 我们引入一个经典的公平组合游戏, Nim 游戏. 

### 2.3 Nim 游戏

我们有$n $堆石子, 每堆有$ a_i $个, 两个玩家轮流取走任意一堆的任意个石子, 但不能不取, 取走最后一个石子的人获胜. 

例如, 如果现在有$ n=3 $堆石子, 而每堆分别有$ 2, 5, 4 $个, 那么可以取走第$ 1 $堆中的$ 2 $个物品, 局面就变成了$ 0, 5, 4$；或者也可以取走第$ 2 $堆的$ 4 $个石子, 局面就变成了$ 2, 1, 4$. 

如果现在的局面为$ 0, 0, 5$, *张三* 取走了第$ 3 $堆的$ 5 $个石子, 也就是取走了最后一个石子, 此时*张三* 获胜. 

#### 2.3.1 低效算法

显然, 我们可以将不同的数组$a$作为状态, 取石子的操作作为博弈状态图上的边, 进而转化为博弈状态图.

因此我们可以在$\varTheta(\prod_{i=1}^n a_i) $的时间(状态的数量)内进行求解, 但这样的复杂度过高.

#### 定理11.2: Nim和 定理

我们定义 Nim和 为$a_i$的异或和(即 Nim和$ =a_1 \oplus a_2 \oplus \ldots \oplus a_n$), 则当且仅当一个状态的 Nim和为 0 时, 该状态为必败状态, 否则为必胜状态.

> **证明**
>
> 首先, Nim 游戏的博弈状态图显然是有向无环图(无法放石子). 其次, 操作是有限的(石子不能无限取).
>
> 接下来我们将证明 3 个定理, 从而证明定理11.2.
>
> 1. 没有后继状态的状态为必败状态. **证明**: 没有后继状态即为全部石子均已取完, 先手必败, 此时Nim和 为0.
>
> 2. 对于 Nim和 不为 0 的局面, 定然可以对其操作使得 Nim和 为 0. **证明**: 我们将操作前的各堆设为$a_1,a_2,...a_n$, 操作后的设为$a_1',a_2',...,a_n'$, 设操作前的 Nim和 为$k\neq0$. 我们另外设$k$的二进制的最高的 $1$ 位为从右到左第$d$位, 则$2^d\le k < 2^{d+1}$. 假设我们是取第$i$堆的石子, 则根据异或运算律($a\oplus a=0$)有$a_i'=a_i\oplus k$. 由于$k$的第$d$位为 $1$, 则$a$中必然有奇数项的第$d$位为$1$, 所以可以找到$a_i$使得$a_i>a_i\oplus k=a_i'$.
> 3. 对于 Nim和 为0 的局面, 定然无法将其操作为 Nim和 为 0 的局面. **证明**: 我们沿用 2. 证明中的定义, 如果我们要将$ a_i $改为 $a_i'$, 则根据异或运算律可以得出 $a_i=a_i'$, 因而这不是个合法的移动. 
>
> 根据上述 3 个定理, 当开始状态的Nim和 不为 0 时, 先手可以将 Nim和 一直变为 0, 而后手只能将 Nim和 变为非 0, 而无后继状态(全部取完)的 Nim和 为0, 所以后手必然要到达必败状态, 从而证明.

#### 2.3.2 时间复杂度分析

我们使用定理11.2求解, 只需要对起始状态求解$a$的异或和, 时间复杂度为$\varTheta(n)$, 相比低效算法有巨大的提升.

### 2.4 多有向图游戏的求解方法( SG 函数)

了解了 Nim 游戏, 我们就可以对多有向图游戏和转化为多有向图游戏的其他公平组合游戏进行高效求解. 为了利用定理11.2, 我们为有向图上的每个点$u$指定一个数(相当于石子数量), 设为$SG(u)$, 称为 **SG 函数**.

类似于 Nim 游戏, 我们设必败状态的 SG 函数为0, 必胜状态的 SG 函数不为0. 显然终止状态(出度为 0 的点)的 SG 函数为 0. 而根据定理11.1, 如果要满足上述设定, 则我们可以发现若点$u$有出点$v$中且有$SG(v)=0$, 则必然有$SG(u)\neq0$(定理11.1.2). 同样的, 也可以发现若对$\forall v$有$SG(v)\neq0$, 则$SG(u)=0$(定理11.1.3).

我们可以将 SG 函数设为任意符合上述条件的函数, 为了适用石子合并, 我们设$SG(u)=\operatorname{mex}\{SG(v)|\forall \langle u,v\rangle\in E\}$, 即$u$的所有出点的 SG 函数所构成的集合的$ \operatorname{mex} $函数.其中定义$ \operatorname{mex} $函数的值为不属于集合$ S $中的最小非负整数, 即$\operatorname{mex}(S)=\min\{x\} \quad (x \notin S, x \in N)$.

我们接下来引入 SG 定理, 通过各个有向图起点的 SG 函数求解对于所有有向图的先后手胜负情况.

#### 定理11.3: SG 定理( Sprague–Grundy 定理)

对于包含$m$个有向图的有向图游戏, 设它们的起点分别为$s_1,s_2,...,s_m$, 则若$SG(s_1)\oplus SG(s_2)\oplus...\oplus SG(s_m)=0$, 必然有方案使先手必败. 类似的, 若$SG(s_1)\oplus SG(s_2)\oplus...\oplus SG(s_m)\neq0$, 则必然有方案使先手必胜.

> **证明**
>
> 我们将每个有向图看做 Nim 游戏中的一堆石子, 每个有向图当前棋子所在状态的 SG 函数看做每堆的石子数, 将这些状态的 SG 函数的异或和看做 Nim和, 则定理11.2依然适用.
>
> 对定理11.2适用性的证明如下:
>
> 1. 对定理11.2.1: 根据上文定义, 没有后继的状态的各点的 SG 函数均为 0, 异或和也为0, 为必败状态.
> 2. 对定理11.2.2: 对于每个点$u$, 设它的 SG 函数为$SG(u)$, 则一定可以从点$u$移动到一个有$0\le SG(v)<SG(u)$的后继点$v$ (根据上文 SG 函数的定义), 和 Nim 游戏相同.
> 3. 对定理11.2.3: 对于每个点$u$, 无论移动到哪一个后继点$v$, 定然有$SG(u)\neq SG(v)$(否则不符合上文对 SG 函数的设置), 和 Nim游戏相同.
>
> 因此, 定理11.2在多有向图上的结果与 Nim 游戏相同, 从而对定理11.3完成证明.

#### 2.4.1 算法流程

我们求解每个有向图起点的 SG 函数, 然后将其异或起来即可.

利用 SG 函数求解多有向图游戏的关键在于推导 SG 函数, 当然对于单有向图游戏的求解也是一样的. 在下文中我们将讲解一个将公平组合游戏化为有向图游戏的例子, 以向读者说明求解公平组合游戏的一般方法.

#### 2.4.2 时间复杂度分析

设有$m$个有向图, 求解每个有向图起点的 SG 函数的时间复杂度为$\varTheta(k)$, 则总时间复杂度为$\varTheta(mk)$.

#### 2.4.3 将一般公平组合游戏化为有向图游戏的应用举例

回来再补吧(doge)...

## 3. 非公平组合游戏

**非公平组合游戏（Partizan Game）**, 与公平组合游戏的区别在于不满足上述第 2 条限制. 其实大部分的棋类游戏都不是公平组合游戏, 如国际象棋, 中国象棋, 围棋, 五子棋等(因为双方都不能使用对方的棋子). 

## 4. 反常游戏

**反常游戏(Mis$\grave{e}$re Game)**, 按照传统的游戏规则进行游戏, 但是其胜者为第一个无法行动的玩家. 以 Nim 游戏为例, Nim 游戏中取走最后一颗石子的为胜者, 而反常 Nim 游戏中取走最后一刻石子的为败者. 

见 OI-Wiki...回来再补吧....

## 5. 参考资料

1. [博弈论](https://oi-wiki.org/math/game-theory/misere-game/) --OI-wiki
2. 《信息学奥赛之数学一本通》